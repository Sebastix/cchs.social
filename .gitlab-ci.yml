image: alpine

# Preparation:
# Save $SSH_PRIVATE_KEY first in GitLab CI variables.
variables:
  DRUPAL_WEB_ROOT: "/var/www/drpl.sebastix.dev/"
  SSH_LOGIN: "ssh -T root@sebastix.dev"

stages:
  - deploy

before_script:
  # @see https://docs.gitlab.com/ee/ci/ssh_keys/
  - 'which ssh-agent || ( apk add --update openssh )'
  - apk add --update bash
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

deploy_staging:
  when: always
  stage: deploy
  only:
    - master
  script:
    - $SSH_LOGIN 'ls -la'
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && git fetch --tags"
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && git pull"
    # Never blindly run composer update on the server: https://blog.martinhujer.cz/17-tips-for-using-composer-efficiently/
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && composer install --optimize-autoloader --no-dev"
    # Updates must be run before configuration is imported
    # https://drupal.stackexchange.com/questions/188840/what-order-should-configuration-import-and-module-updates-be-run
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && $DRUSH updatedb -y"
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && $DRUSH config-import -y"
    # (Additional) sanitizing tasks.
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && $DRUSH locale:check"
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT; $DRUSH locale:update"
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && drush core-cron"
    # You should consider fine-grained cache invalidation
    # @see https://www.dx-experts.nl/blog/2017/drupal-8-development-caching
    #- $SSH_LOGIN "cd $DRUPAL_WEB_ROOT && drush cache-rebuild -y"
